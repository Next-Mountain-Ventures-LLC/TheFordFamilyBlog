---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { buttonVariants } from "@/components/ui/button";
import SubscribeForm from "@/components/SubscribeForm";
import joshuaImage from '../assets/joshua-ford-family-profile_nw_79fe0e22.jpg';
import saliciaImage from '../assets/salicias-profile_nw_7fb06e56.jpg';
import jacksonImage from '../assets/jackson_ford_nw_10531fa1.jpg';
import finleyImage from '../assets/finley-profile-image_nw_40f934be.jpg';
import { getAuthorFullName, getPosts } from '../lib/wordpress';

interface Props {
  title: string;
  description?: string;
  author: string;
  date: string;
  category: string;
  categorySlug?: string;
  imageUrl?: string;
  ogImage?: URL;
  tags?: Array<{id: number, name: string, slug: string}>;
  authorSlug?: string;
}

const { title, description, author: rawAuthor, date, category, categorySlug, imageUrl, ogImage, tags, authorSlug } = Astro.props;

// Map email usernames to full names if needed
const author = getAuthorFullName(rawAuthor);

// Get latest WordPress posts for the sidebar
let latestPosts = [];
try {
  latestPosts = await getPosts(3);
  console.log('Successfully fetched latest posts for blog sidebar');
} catch (error) {
  console.error('Error fetching latest posts for sidebar:', error);
}
---

<BaseLayout title={title} description={description} ogImage={ogImage}>
  <div class="bg-muted/20 py-10 border-b border-primary/10">
    <div class="container max-w-4xl mx-auto">
      <div class="flex items-center space-x-2 mb-2">
        <a href="/blog" class="text-primary hover:text-primary-foreground transition-colors">
          Blog
        </a>
        <span class="text-muted-foreground">/</span>
        <a href={`/blog/category/${categorySlug || category.toLowerCase().replace(/\s+/g, '-')}`} class="text-primary hover:text-primary-foreground transition-colors">
          {category}
        </a>
      </div>
      
      <h1 class="text-3xl md:text-5xl font-bold font-display mb-4 text-primary-foreground">
        {title}
      </h1>
      
      <div class="flex flex-wrap items-center text-sm text-muted-foreground gap-x-4 gap-y-2 mb-8">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          <a 
            href={authorSlug ? `/blog/author/${authorSlug}` : `#`}
            class="hover:text-primary transition-colors"
          >
            {author}
          </a>
        </div>
        
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span>{date}</span>
        </div>
        
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="m7 20-3-3m0 0 3-3m-3 3h13m3-9-3 3m0 0 3 3m-3-3H7"></path></svg>
          <span>Share</span>
        </div>
      </div>
    </div>
  </div>
  
  <main class="py-12">
    <div class="container mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <article class="scrapbook-paper bg-white/95 mb-8">
            {/* Only display images from WordPress */}
            {imageUrl && (
              <div class="mb-6 -mt-2 -mx-2">
                <div class="scrapbook-photo w-full" style="--rotate: 0deg;">
                  <div class="scrapbook-tape"></div>
                  <img 
                    src={imageUrl} 
                    alt={title}
                    class="w-full h-48 sm:h-64 object-cover rounded-sm"
                  />
                </div>
              </div>
            )}
            
            <div class="prose prose-slate max-w-none">
              <slot />
            </div>
            
            {tags && tags.length > 0 && (
              <div class="mt-8 pt-6 border-t border-border">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="text-sm font-medium">Tags:</span>
                  {tags.map(tag => (
                    <a 
                      href={`/blog/tag/${tag.slug}`}
                      class="inline-block px-3 py-1 bg-muted text-muted-foreground text-xs rounded-full hover:bg-muted/80 transition-colors"
                    >
                      #{tag.name}
                    </a>
                  ))}
                </div>
              </div>
            )}
          </article>
          
          <!-- Author Bio -->
          <div class="scrapbook-paper bg-accent/5">
            <div class="flex flex-col sm:flex-row gap-4 items-center sm:items-start">
              <div class="scrapbook-photo" style="--rotate: -2deg;">
                <div class="scrapbook-tape"></div>
                <img 
                  src={author === "Salicia Ford" 
                    ? saliciaImage.src
                    : author === "Joshua Ford"
                      ? joshuaImage.src
                      : author === "Jackson Ford"
                        ? jacksonImage.src
                        : author === "Finley Ford"
                          ? finleyImage.src
                          : "https://secure.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y"
                  }
                  alt={author}
                  class="w-20 h-20 object-cover rounded-sm"
                />
              </div>
              <div>
                <h3 class="font-display font-bold text-lg">{author}</h3>
                <p class="text-muted-foreground mb-3">
                  {author === "Salicia Ford" 
                    ? "Patient Advocate & Homeschool Mom" 
                    : author === "Joshua Ford"
                      ? "Writer & Entrepreneur"
                      : author === "Jackson Ford"
                        ? "Young Inventor & Entrepreneur"
                        : "Designer & Aspiring Actress"
                  }
                </p>
                <p class="text-sm mb-3">
                  {author === "Salicia Ford" 
                    ? "Salicia shares her journey battling autoimmune diseases while homeschooling and helping families through Anchor and Bloom." 
                    : author === "Joshua Ford"
                      ? "Joshua shares insights on entrepreneurship, inventions, and creative projects through Next Mountain Ventures."
                      : author === "Jackson Ford"
                        ? "Jackson explores 3D printing, inventions, and youth entrepreneurship through his unique perspective."
                        : "Finley brings creativity to life through design, acting, and fashion-forward YouTube content."
                  }
                </p>
                <a href={`/${author.split(" ")[0].toLowerCase()}`} class={buttonVariants({ variant: 'outline', size: 'sm' })}>
                  More from {author.split(" ")[0]}
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sidebar -->
        <div class="space-y-8">
          <div class="scrapbook-paper bg-white/90">
            <h3 class="font-display font-bold text-xl mb-4">Latest Posts</h3>
            <div class="space-y-4">
              {latestPosts.length > 0 ? (
                latestPosts.map(post => (
                  <div class="flex items-start gap-3">
                    <div class="shrink-0 mt-1">
                      <div class="h-16 w-16 bg-muted rounded-sm overflow-hidden">
                        <img 
                          src={post.imageUrl || 
                            (post.author.includes('Salicia') ? saliciaImage.src : 
                             post.author.includes('Joshua') ? joshuaImage.src : 
                             post.author.includes('Jackson') ? jacksonImage.src : 
                             post.author.includes('Finley') ? finleyImage.src : 
                             saliciaImage.src)} 
                          alt={post.title} 
                          class="h-full w-full object-cover" 
                        />
                      </div>
                    </div>
                    <div>
                      <h4 class="font-medium text-sm leading-tight mb-1">
                        <a href={`/blog/${post.slug}`} class="hover:text-primary">
                          {post.title}
                        </a>
                      </h4>
                      <p class="text-xs text-muted-foreground">{post.date}</p>
                    </div>
                  </div>
                ))
              ) : (
                <div class="text-sm text-muted-foreground">No posts found</div>
              )}
            </div>
          </div>
          
          <div class="scrapbook-paper bg-white/90">
            <h3 class="font-display font-bold text-xl mb-4">Categories</h3>
            <div class="flex flex-wrap gap-2">
              <a href="/blog/category/faith-health" class="px-3 py-1.5 bg-primary/10 text-primary-foreground text-sm rounded-md hover:bg-primary/20 transition-colors">
                Faith & Health
              </a>
              <a href="/blog/category/homeschooling" class="px-3 py-1.5 bg-secondary/10 text-secondary-foreground text-sm rounded-md hover:bg-secondary/20 transition-colors">
                Homeschooling
              </a>
              <a href="/blog/category/inventions" class="px-3 py-1.5 bg-accent/10 text-accent-foreground text-sm rounded-md hover:bg-accent/20 transition-colors">
                Inventions
              </a>
              <a href="/blog/category/entrepreneurship" class="px-3 py-1.5 bg-muted text-muted-foreground text-sm rounded-md hover:bg-muted/70 transition-colors">
                Entrepreneurship
              </a>
              <a href="/blog/category/family" class="px-3 py-1.5 bg-primary/10 text-primary-foreground text-sm rounded-md hover:bg-primary/20 transition-colors">
                Family
              </a>
            </div>
          </div>
          
          <div class="scrapbook-paper bg-secondary/5">
            <h3 class="font-display font-bold text-xl mb-4">Subscribe</h3>
            <p class="text-sm mb-4">Get the latest posts delivered straight to your inbox.</p>
            <SubscribeForm client:load />
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>
