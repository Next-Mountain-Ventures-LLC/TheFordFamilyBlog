---
import BaseLayout from "@/layouts/BaseLayout.astro";
import TextSubscribeForm from '@/components/TextSubscribeForm';
import { Image } from 'astro:assets';
import familyImage from '../assets/joshua_ford_family_profile_nw_c781cd7e.jpg';
import saliciaImage from '../assets/salicias-profile_nw_7fb06e56.jpg';

// Check for URL parameter 'type=prayer'
const { searchParams } = Astro.url;
const hasPrayerParam = searchParams.get('type') === 'prayer';
const headingText = hasPrayerParam ? "Prayer Request from" : "Stay Connected with";

// Also adjust page title if prayer parameter is present
const pageTitle = hasPrayerParam 
  ? "Prayer Request from The Ford Family" 
  : "Subscribe to Updates from The Ford Family";
---

<BaseLayout title={pageTitle} description="Sign up to receive updates from the Ford family" image={new URL('/us_nw_a4501e2a.png', Astro.site)}>

<slot name="head">
  <meta property="og:title" content={pageTitle} />
  <meta name="twitter:title" content={pageTitle} />
  <!-- Debug information -->
  <script is:inline define:vars={{ hasPrayerParam, typeParam: searchParams.get('type'), saliciaImageSrc: saliciaImage.src }}>
    console.log('URL parameters:', window.location.search);
    console.log('type parameter:', typeParam);
    console.log('hasPrayerParam:', hasPrayerParam);
    console.log('Salicia image src:', saliciaImageSrc);
    
    // Client-side detection as fallback
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const clientTypeParam = params.get('type');
      console.log('Client-side detection running', clientTypeParam);
      
      if (clientTypeParam === 'prayer') {
        console.log('Prayer parameter detected on client side');
        
        // Update heading and title
        document.getElementById('dynamic-heading').textContent = 'Prayer Request from';
        document.title = 'Prayer Request from The Ford Family';
        
        // Force image swap to Salicia's image - multiple approaches for robustness
        setTimeout(() => {
          // Use the direct Astro-generated URL for Salicia's image
          const saliciaDirectUrl = saliciaImageSrc;
          
          // Approach 1: Direct querySelector
          const heroImage = document.querySelector('.hero-image-swap');
          console.log('Hero image found:', heroImage);
          
          if (heroImage && heroImage.tagName === 'IMG') {
            console.log('Before image swap:', heroImage.src);
            // Use the direct Astro-generated URL
            heroImage.src = saliciaDirectUrl;
            heroImage.srcset = ''; // Clear srcset if any
            console.log('After image swap:', heroImage.src);
          }
          
          // Approach 2: Find image by selector and position
          const heroContainer = document.querySelector('.order-1.md\\:order-2');
          if (heroContainer) {
            const containerImages = heroContainer.querySelectorAll('img');
            if (containerImages.length > 0) {
              const targetImage = containerImages[0];
              console.log('Container image found:', targetImage);
              targetImage.src = saliciaDirectUrl;
              targetImage.srcset = ''; // Clear srcset if any
            }
          }
        }, 100); // Small delay to ensure DOM is fully loaded
        
        // Update paragraph text if needed
        const introParagraph = document.querySelector('.intro-paragraph');
        if (introParagraph) {
          introParagraph.innerHTML = "We Believe in the Power of Prayer! So many of you have been praying for our family, and we have seen so many supernatural things come from your prayer. It has been on our hearts for a very long time to create a family blog page where we can share updates and prayer requests to everyone. Not only to send out prayer request directly to all of you but to also communicate back to you with updates as those prayers are answered! Please share this page with anyone who would like to sign up to receive prayer requests or updates from our family. Thank you, everyone!";
        }
      }
    });
  </script>
</slot>

<!-- Additional image-specific script to ensure proper loading -->
<style>
  /* Media queries for mobile/desktop specific display */
  .mobile-only { display: none; }
  .desktop-only { display: inline-block; }
  @media (max-width: 768px) {
    .mobile-only { display: inline-block; }
    .desktop-only { display: none; }
  }
</style>
<script is:inline define:vars={{ saliciaImageSrc: saliciaImage.src, familyImageSrc: familyImage.src }}>
  // This script runs immediately without waiting for DOMContentLoaded
  (function() {
    // Get the correct image sources from Astro
    const saliciaImageUrl = saliciaImageSrc; // This will be the optimized URL from Astro
    const familyImageUrl = familyImageSrc;   // This will be the optimized URL from Astro
    
    console.log("Available image URLs (from Astro):", { saliciaImageUrl, familyImageUrl });
    
    // Run this script immediately
    function checkAndUpdateImage() {
      const params = new URLSearchParams(window.location.search);
      const isPrayer = params.get('type') === 'prayer';
      
      if (isPrayer) {
        console.log('Immediate image check - prayer mode detected');
        
        // Force image to Salicia
        function replaceImage() {
          // Find all images in the hero container
          const heroContainer = document.querySelector('.order-1.md\\:order-2');
          if (!heroContainer) {
            console.log('Could not find hero container');
            return;
          }
          
          // Try to find the image by various methods
          const images = heroContainer.querySelectorAll('img');
          console.log(`Found ${images.length} images in hero container`);
          
          for (let i = 0; i < images.length; i++) {
            const img = images[i];
            console.log(`Image ${i+1}:`, img.src);
            
            // Check if this is the family image that needs replacing
            if (img.src.includes('joshua') || img.src.includes('family') || !img.src.includes('salicia')) {
              console.log('Found family image, replacing with Salicia image');
              
              // Store original dimensions
              const originalWidth = img.width || 500;
              const originalHeight = img.height || 700;
              
              // Update the source directly to the optimized Salicia image URL
              img.src = saliciaImageUrl;
              img.srcset = ''; // Clear any srcset
              img.alt = 'Salicia Ford';
              img.width = originalWidth;
              img.height = originalHeight;
              
              console.log('Image updated to:', img.src);
            }
          }
          
          // If no images found, try to find by ID
          if (images.length === 0) {
            const heroImage = document.getElementById('hero-image');
            if (heroImage) {
              console.log('Found hero image by ID');
              heroImage.src = saliciaImageUrl;
              heroImage.alt = 'Salicia Ford';
              console.log('Updated image by ID');
            }
          }
        }
        
        // Try immediately and then with a delay for reliability
        replaceImage();
        setTimeout(replaceImage, 100);
        setTimeout(replaceImage, 500);
      }
    }
    
    // Run once immediately 
    checkAndUpdateImage();
    
    // Also run when the DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAndUpdateImage);
    } else {
      // DOM already loaded, run now
      setTimeout(checkAndUpdateImage, 0);
    }
    
    // And again after everything is loaded
    window.addEventListener('load', checkAndUpdateImage);
  })();
</script>
  <div class="container max-w-4xl mx-auto px-4 py-12">
    <div class="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
      <div class="order-2 md:order-1">
        <div class="mb-8">
          <h1 class="text-3xl font-bold font-display tracking-tight mb-4 text-center">
            <span id="dynamic-heading">{headingText}</span><br/><span class="text-4xl">The Ford Family</span>
          </h1>
          <p class="text-lg text-muted-foreground mb-6 intro-paragraph">
            {hasPrayerParam ? 
              "We Believe in the Power of Prayer! So many of you have been praying for our family, and we have seen so many supernatural things come from your prayer. It has been on our hearts for a very long time to create a family blog page where we can share updates and prayer requests to everyone. Not only to send out prayer request directly to all of you but to also communicate back to you with updates as those prayers are answered! Please share this page with anyone who would like to sign up to receive prayer requests or updates from our family. Thank you, everyone!" 
              : 
              "We've had a lot of people asking for updates on Salicia and our family. We're trying to do a lot better about being able to update everybody at once so we created this blog with text and email notifications."
            }
          </p>
          
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-100 mb-6" id="intro-box">
            <p class="text-sm text-blue-700">
              <span class="font-medium">Please fill out the form below</span> to sign up for text message and email updates and join our prayer list.
            </p>
          </div>
          
          <div class="mb-6">
            <div class="flex justify-center gap-3 mb-2">
              <a 
                href="#"
                onclick="if(navigator.share) { navigator.share({ title: 'Ford Family Updates', url: window.location.href }); } else { window.open('https://www.facebook.com/dialog/send?app_id=741024618086022&link=' + encodeURIComponent(window.location.href) + '&redirect_uri=' + encodeURIComponent(window.location.href), '_blank'); } return false;"
                class="flex items-center justify-center p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                aria-label="Share this page"
              >
                <span class="mobile-only"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></span>
                <span class="desktop-only"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-facebook"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>
              </a>
              
              <a 
                href={`sms:?body=${hasPrayerParam ? "Prayer Request from The Ford Family: " : "Subscribe to Updates from The Ford Family: "}${encodeURIComponent(Astro.url.href)}`}
                class="flex items-center justify-center p-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors"
                aria-label="Share via SMS"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
              </a>
              
              <a 
                href={`mailto:?subject=${hasPrayerParam ? "Prayer Request from The Ford Family" : "Subscribe to Updates from The Ford Family"}&body=Hey,%0A%0A${hasPrayerParam ? "The Ford Family is sharing prayer requests and updates. " : ""}Joshua and Salicia made a page where you can sign up to receive prayer requests and updates on their family.%0A%0AHere's the link: ${encodeURIComponent(Astro.url.href)}%0A%0AThanks!`}
                class="flex items-center justify-center p-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors"
                aria-label="Share via Email"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>
              </a>
            </div>
            <p class="text-xs text-center text-muted-foreground">Please share this page so that others can pray for our family and receive updates</p>
          </div>
        </div>
        
        <TextSubscribeForm client:load />
      </div>
      
      <div class="order-1 md:order-2 flex justify-center">
        <div class="relative">
          <div class="absolute inset-0 bg-gradient-to-tr from-primary/30 to-transparent rounded-xl transform rotate-6 -z-10"></div>
          {hasPrayerParam ? (
            <Image 
              src={saliciaImage} 
              alt="Salicia Ford" 
              width={500}
              height={700}
              class="rounded-xl shadow-lg object-cover hero-image-swap prayer-image"
              id="hero-image"
            />
          ) : (
            <Image 
              src={familyImage} 
              alt="The Ford Family" 
              width={500}
              height={700}
              class="rounded-xl shadow-lg object-cover hero-image-swap family-image"
              id="hero-image"
            />
          )}
        </div>
      </div>
    </div>
    
    <div class="mt-12 pt-8 border-t text-center">
      <p class="text-sm text-muted-foreground">
        By subscribing, you agree to receive messages from The Ford Family. Message frequency varies.
        We respect your privacy and will never share your information with third parties.
      </p>
    </div>
  </div>
</BaseLayout>