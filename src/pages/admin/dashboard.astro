---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { getCollection } from 'astro:content';

// Get blog posts from content collection
const allBlogPosts = await getCollection('blog');

// Get unique categories
const categories = [...new Set(allBlogPosts.map(post => post.data.category))];

// Transform content collection entries into blog post objects and sort by date (newest first)
const blogPosts = allBlogPosts.map(entry => ({
  title: entry.data.title,
  date: entry.data.date,
  author: entry.data.author,
  category: entry.data.category,
  slug: entry.slug
})).sort((a, b) => {
  const dateA = new Date(a.date);
  const dateB = new Date(b.date);
  return dateB - dateA;
});

// Take only the 5 most recent posts
const recentPosts = blogPosts.slice(0, 5);
---

<AdminLayout title="Admin Dashboard">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
    <div class="bg-white p-6 rounded-lg shadow-sm border border-border">
      <h3 class="text-xl font-bold mb-2">Posts</h3>
      <p class="text-3xl font-bold text-primary">{allBlogPosts.length}</p>
      <p class="text-muted-foreground text-sm">Total blog posts</p>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-sm border border-border">
      <h3 class="text-xl font-bold mb-2">Categories</h3>
      <p class="text-3xl font-bold text-primary">{categories.length}</p>
      <p class="text-muted-foreground text-sm">Blog categories</p>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-sm border border-border">
      <h3 class="text-xl font-bold mb-2">Actions</h3>
      <div class="space-y-2">
        <a href="/admin/new-post" class="block w-full py-2 px-4 bg-primary text-primary-foreground rounded text-center font-medium hover:bg-primary/90 transition-colors">
          Create New Post
        </a>
        <a href="/admin/manage-posts" class="block w-full py-2 px-4 bg-secondary text-secondary-foreground rounded text-center font-medium hover:bg-secondary/90 transition-colors">
          Manage Posts
        </a>
      </div>
    </div>
  </div>
  
  <div class="bg-white rounded-lg shadow-sm border border-border p-6 mb-10">
    <h3 class="text-xl font-bold mb-4">Recent Posts</h3>
    
    {recentPosts.length === 0 ? (
      <p class="text-muted-foreground py-4">No posts yet. Create your first post!</p>
    ) : (
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-border">
              <th class="text-left py-2 px-4 font-semibold">Title</th>
              <th class="text-left py-2 px-4 font-semibold">Category</th>
              <th class="text-left py-2 px-4 font-semibold">Author</th>
              <th class="text-left py-2 px-4 font-semibold">Date</th>
              <th class="text-right py-2 px-4 font-semibold">Action</th>
            </tr>
          </thead>
          <tbody>
            {recentPosts.map(post => (
              <tr class="border-b border-border hover:bg-muted/20">
                <td class="py-3 px-4">{post.title}</td>
                <td class="py-3 px-4">
                  <span class="px-2 py-1 bg-primary/10 text-primary-foreground text-xs rounded-full">
                    {post.category}
                  </span>
                </td>
                <td class="py-3 px-4">{post.author}</td>
                <td class="py-3 px-4">{post.date}</td>
                <td class="py-3 px-4 text-right">
                  <a href={`/blog/${post.slug}`} class="text-blue-600 hover:underline text-sm" target="_blank">
                    View
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </div>
  
  <div class="bg-white rounded-lg shadow-sm border border-border p-6">
    <h3 class="text-xl font-bold mb-4">Categories</h3>
    
    <div class="flex flex-wrap gap-2">
      {categories.map(category => (
        <div class="bg-muted/20 px-4 py-2 rounded-full">
          {category}
          <span class="ml-2 bg-muted text-muted-foreground text-xs px-2 py-0.5 rounded-full">
            {allBlogPosts.filter(post => post.data.category === category).length}
          </span>
        </div>
      ))}
    </div>
  </div>
</AdminLayout>